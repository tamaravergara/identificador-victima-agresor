<!doctype html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Identificador Víctima y Agresor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg, #0F1F38 0%, #1a2332 100%); }
    .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.2); }
    .card { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.4); }
    .tab-active { background: #475569; color: white; }
    .tab-inactive { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }
    .progress { width: 0%; transition: width 0.6s ease; }
  </style>
</head>
<body class="min-h-screen text-white font-sans">

  <div class="max-w-6xl mx-auto p-6">

    <!-- Header bonito -->
    <header class="text-center mb-12 mt-8">
      <h1 class="text-5xl font-bold mb-3">Identificador Víctima y Agresor</h1>
      <p class="text-xl opacity-90">Sistema de detección de violencia con YOLO + DeepSORT</p>
      <div class="flex justify-center mt-4">
        <div class="flex items-center space-x-3 bg-green-600/20 px-6 py-2 rounded-full border border-green-500">
          <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
          <span class="font-medium">Backend conectado</span>
        </div>
      </div>
    </header>

    <!-- Tabs elegantes -->
    <div class="glass rounded-2xl card p-8 mb-10">
      <div class="flex justify-center space-x-4 mb-8">
        <button id="tab-upload" class="tab-active px-8 py-4 rounded-xl font-bold text-lg transition-all">Subir Video Local</button>
        <button id="tab-youtube" class="tab-inactive px-8 py-4 rounded-xl font-bold text-lg transition-all">URL de YouTube</button>
      </div>

      <div id="upload-zone" class="border-4 border-dashed border-white/30 rounded-2xl p-16 text-center hover:border-white/60 transition-all">
        <input type="file" id="video-file" accept="video/*" class="hidden">
        <svg class="w-20 h-20 mx-auto mb-6 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
        </svg>
        <p class="text-2xl font-medium mb-4">Arrastra tu video aquí o haz clic</p>
        <button onclick="document.getElementById('video-file').click()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-10 py-4 rounded-xl font-bold text-xl shadow-xl">
          Seleccionar Video
        </button>
        <p id="file-info" class="mt-6 text-green-400 font-bold text-xl"></p>
      </div>

      <div id="youtube-zone" class="hidden">
        <input type="text" id="youtube-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-8 py-5 text-xl bg-white/10 border border-white/30 rounded-xl focus:outline-none focus:border-white">
      </div>
    </div>

    <!-- Botón grande y bonito -->
    <div class="text-center mb-12">
      <button id="process-btn" class="bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white font-bold text-3xl py-7 px-24 rounded-2xl shadow-2xl transform hover:scale-105 transition-all duration-300">
        INICIAR ANÁLISIS CON IA
      </button>
    </div>

    <!-- Progreso -->
    <div id="progress" class="hidden glass rounded-2xl card p-10 text-center mb-10">
      <h3 class="text-3xl font-bold mb-6">Procesando video con IA...</h3>
      <div class="w-full bg-white/20 rounded-full h-12 overflow-hidden">
        <div id="bar" class="progress bg-gradient-to-r from-red-600 to-red-800 h-full flex items-center justify-center text-xl font-bold">0%</div>
      </div>
      <p class="mt-6 text-lg opacity-80">YOLOv8 + DeepSORT + análisis de interacción</p>
    </div>

    <!-- Resultados -->
    <div id="results" class="hidden space-y-10">
      <div class="glass rounded-2xl card p-10">
        <h2 class="text-4xl font-bold mb-8 text-center">Resumen del Análisis</h2>
        <div id="summary" class="bg-black/30 p-8 rounded-xl text-lg leading-relaxed whitespace-pre-line"></div>
      </div>

      <div class="glass rounded-2xl card p-10">
        <h2 class="text-4xl font-bold mb-8 text-center">Video Procesado</h2>
        <video id="output-video" controls class="w-full rounded-2xl shadow-2xl"></video>
      </div>

      <div class="grid grid-cols-3 gap-8">
        <div class="glass rounded-2xl p-8 text-center">
          <div id="aggressors" class="text-6xl font-bold text-red-500">0</div>
          <p class="text-xl mt-3">Agresores únicos</p>
        </div>
        <div class="glass rounded-2xl p-8 text-center">
          <div id="victims" class="text-6xl font-bold text-blue-500">0</div>
          <p class="text-xl mt-3">Víctimas únicas</p>
        </div>
        <div class="glass rounded-2xl p-8 text-center">
          <div id="frames" class="text-6xl font-bold text-green-500">0</div>
          <p class="text-xl mt-3">Frames con violencia</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // PROXY QUE SÍ FUNCIONA HOY (14 nov 2025)
    const BACKEND_URL = "https://corsproxy.io/?" + encodeURIComponent("https://camcel-identificador-victima-y-agresor.hf.space/predict");

    // Tabs
    document.getElementById('tab-upload').onclick = () => switchTab(true);
    document.getElementById('tab-youtube').onclick = () => switchTab(false);
    function switchTab(upload) {
      document.getElementById('tab-upload').classList.toggle('tab-active', upload);
      document.getElementById('tab-upload').classList.toggle('tab-inactive', !upload);
      document.getElementById('tab-youtube').classList.toggle('tab-active', !upload);
      document.getElementById('tab-youtube').classList.toggle('tab-inactive', upload);
      document.getElementById('upload-zone').classList.toggle('hidden', !upload);
      document.getElementById('youtube-zone').classList.toggle('hidden', upload);
    }

    // Nombre del archivo
    document.getElementById('video-file').onchange = function() {
      if (this.files[0]) {
        const size = (this.files[0].size / 1024 / 1024).toFixed(1);
        document.getElementById('file-info').textContent = `Listo: ${this.files[0].name} (${size} MB)`;
      }
    };

    // Botón principal
    document.getElementById('process-btn').onclick = async () => {
      const file = document.getElementById('video-file').files[0];
      const yt = document.getElementById('youtube-url').value.trim();
      if (!file && !yt) return alert("Sube un video o pega un link de YouTube");

      const form = new FormData();
      if (file) form.append("video", file);
      if (yt) form.append("youtube_url", yt);
      form.append("aggressor_threshold", "2.8");
      form.append("victim_threshold", "1.5");
      form.append("proximity_threshold", "140");
      form.append("mostrar_interaccion", "Ambos");

      document.getElementById('progress').classList.remove('hidden');
      document.getElementById('results').classList.add('hidden');
      let p = 0;
      const iv = setInterval(() => {
        p += 10;
        if (p > 90) p = 90;
        document.getElementById('bar').style.width = p + '%';
        document.getElementById('bar').textContent = p + '%';
      }, 900);

      try {
        const res = await fetch(BACKEND_URL, { method: "POST", body: form });
        if (!res.ok) throw new Error("Error del servidor: " + res.status);
        const data = await res.json();

        clearInterval(iv);
        document.getElementById('bar').style.width = '100%';
        document.getElementById('bar').textContent = '100%';

        setTimeout(() => {
          document.getElementById('progress').classList.add('hidden');
          document.getElementById('results').classList.remove('hidden');
          document.getElementById('summary').textContent = data.resumen || "Análisis completado";
          if (data.video) document.getElementById('output-video').src = "data:video/mp4;base64," + data.video;
          if (data.log_json) {
            document.getElementById('aggressors').textContent = data.log_json.unique_aggressors || 0;
            document.getElementById('victims').textContent = data.log_json.unique_victims || 0;
            document.getElementById('frames').textContent = data.log_json.frames_with_aggressor || 0;
          }
        }, 1000);

      } catch (e) {
        clearInterval(iv);
        document.getElementById('progress').classList.add('hidden');
        alert("Error: " + e.message + "\nPrimero arregla el backend (deep-sort-realtime)");
      }
    };
  </script>
</body>
</html>

